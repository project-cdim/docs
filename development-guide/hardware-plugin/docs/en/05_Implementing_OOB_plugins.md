# 5. Implementing OOB Plugins

This chapter describes the specifications of OOB plugins for each method.

## 5.1. `get_device_info()`

``` python
get_device_info() -> list[OOBDeviceListItem]
```

Gets the identity of the device that the manager controls.

### 5.1.1. Parameters

No parameters.

### 5.1.2. Return Value

A list of `OOBDeviceListItem` containing device identification information (see [Table 5-2. Return Value of `get_device_info`](05a_Implementing_OOB_plugins_Appendix.md#table-5-2-return-value-of-get_device_info)).  
Raise the following exception on errors:

|No.|Case                                     |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 2 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.1.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Run `Get device ID list information` to get a list of device IDs.

The `deviceID` returned by the REST API is a unique string generated by the HW control function.  
To find out which device this `deviceID` corresponds to collected by the plugin, check `Get spec information`.

## 5.2. `get_spec_info(key_values)`

``` python
get_spec_info(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Get spec information of the specified devices.

### 5.2.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).  

### 5.2.2. Return Value

A dictionary containing the spec information for each device (see [Table 5-4. Return Value of `get_spec_info`](05a_Implementing_OOB_plugins_Appendix.md#table-5-4-return-value-of-get_spec_info)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 4 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.2.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Run `Get device ID list information` to get a list of device IDs.
2. Specify the acquired device ID and run `Get spec Information` to obtain the spec information of the device.

For the correspondence between the return value of the plugin and the item name of the REST API,
refer to [Table 5-5. Mapping from Spec Information to REST API Item Names](05a_Implementing_OOB_plugins_Appendix.md#table-5-5-mapping-from-spec-information-to-rest-api-item-names).

## 5.3. `get_metric_info(key_values)`

``` python
get_metric_info(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Get metric information of the specified devices.

### 5.3.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).  
  In the case of this method, the device type can be one of `CPU`, `GPU`, `memory`, `storage` or `networkInterface`.  

### 5.3.2. Return Value

A dictionary containing the metric information for each device (see [Table 5-6. Return Value of `get_metric_info`](05a_Implementing_OOB_plugins_Appendix.md#table-5-6-return-value-of-get_metric_info)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 4 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.3.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Run `Get device ID list information` to get a list of device IDs.
2. Specify the acquired device ID and run `Get metric Information` to obtain the metric information of the device.

For the correspondence between the return value of the plugin and the item name of the REST API,
refer to [Table 5-7. Mapping from Metric Information to REST API Item Names](05a_Implementing_OOB_plugins_Appendix.md#table-5-7-mapping-from-metric-information-to-rest-api-item-names).

## 5.4. `get_power_state(key_values)`

``` python
get_power_state(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Get the power state of the specified devices.

### 5.4.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).

### 5.4.2. Return Value

A dictionary containing the power states for each device (see [Table 5-8. Return Value of `get_power_state`](05a_Implementing_OOB_plugins_Appendix.md#table-5-8-return-value-of-get_power_state)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 4 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.4.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Specify `CPU` as the device type and run `Get device ID list information` to get a list of device IDs.
2. Configure the settings to run `Get OS boot status`.  
   (`Get OS boot status` accesses the agent running on the device. Follow these steps to set up the agent as a [stub](03_Setup.md#31-setting-up-the-stub).)
   1. Open `hw-control/data/device_id_info.json` and look for an object where `DeviceID` matches the device ID obtained in step 1.

   2. Record the value of `fmPortID`. For example

      ``` json
      {
        "DeviceID":"f1f1c82b-9612-4623-8238-d16906812854",
        "deviceType":"CPU",
        "fmPortID":{
          "FM1":[
            "e4021cb4-79d9-438a-a8e9-60939fe01deb"
          ]
        },
        ..
      ```

      In this example, the device ID is `f1f1c82b-9612-4623-8238-d16906812854`, the FM manager ID is `FM1`, and the `fmPortID` is `e4021cb4-79d9-438a-a8e9-60939fe01deb`.  
      If `fmPortID` is not set (an empty object), set it as shown in the example above.  

   3. Open `hw-control/config/os_ipaddress.yaml` and set `IPAddress` to `localhost` for `fmPortID` that you recorded or set.

      ``` yaml
      OS_IPAddress:
          - fmPortID: "e4021cb4-79d9-438a-a8e9-60939fe01deb"
            IPAddress: "localhost"
      ```

   4. Restart the HW control function.

3. Specify the device ID obtained in step 1 and run `Get OS boot status`.

`Get OS boot status` succeeds when the device power state is `On` or `PoweringOn`.  
Otherwise, it fails and outputs an error as following.

``` json
{
  "code": "EF003BAS007",
  "message": "The specified device power state is already off."
}
{
  "code": "EF010BAS000",
  "message": "The server encountered an internal error. The specified device power state is unexpected."
}
```

## 5.5. `post_power_on(key_values)`

``` python
post_power_on(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Turn on the power of the specified devices.  
If the device is turned on, the process is skipped and the status is set to normal.

### 5.5.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).

### 5.5.2. Return Value

A dictionary containing the execution results (see [Table 5-9. Return Value of Update Methods](05a_Implementing_OOB_plugins_Appendix.md#table-5-9-return-value-of-update-methods)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If the device is not power capable        |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 4 |If the power fails to turn on             |[`PowerOnFailureHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 5 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 6 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.5.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Run `Get device ID list information` to get a list of device IDs.
2. Specify the acquired device ID and run `Power control` with the request body `{"action": "on"}`.

## 5.6. `post_power_off(key_values)`

``` python
post_power_off(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Turn off the power of the specified devices.  
If the device is turned off, the process is skipped and the status is set to normal.

### 5.6.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).

### 5.6.2. Return Value

A dictionary containing the execution results (see [Table 5-9. Return Value of Update Methods](05a_Implementing_OOB_plugins_Appendix.md#table-5-9-return-value-of-update-methods)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If the device is not power capable        |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 4 |If the power fails to turn off            |[`PowerOffFailureHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 5 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 6 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.6.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Run `Get device ID list information` to get a list of device IDs.
2. Specify the acquired device ID and run `Power control` with the request body `{"action": "force-off"}`.

## 5.7. `post_cpu_reset(key_values)`

``` python
post_cpu_reset(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Reset the specified CPU's.

### 5.7.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).

### 5.7.2. Return Value

A dictionary containing the execution results (see [Table 5-9. Return Value of Update Methods](05a_Implementing_OOB_plugins_Appendix.md#table-5-9-return-value-of-update-methods)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If the device is not power capable        |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 4 |If the device is turned off               |[`RequestConflictHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 5 |If CPU reset fails                        |[`CpuResetFailureHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 6 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 7 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.7.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Specify `CPU` as the device type and run `Get device ID list information` to get a list of device IDs.
2. Specify the acquired device ID and run `Power control` with the request body `{"action": "reset"}`.

## 5.8. `post_os_shutdown(key_values)`

``` python
post_os_shutdown(key_values: list[dict[str, str]]) -> dict[str, list[dict]]
```

Shut down the specified device's operating system.  
If the device is turned off, the process is skipped and the status is set to normal.

### 5.8.1. Parameters

- `key_values`  
  A list of dictionaries containing OOB device IDs and device types (see [Table 5-3. Parameter `key_values`](05a_Implementing_OOB_plugins_Appendix.md#table-5-3-parameter-key_values)).

### 5.8.2. Return Value

A dictionary containing the execution results (see [Table 5-9. Return Value of Update Methods](05a_Implementing_OOB_plugins_Appendix.md#table-5-9-return-value-of-update-methods)).  
Raise the following exception on errors:

|No.|Case                                      |Exception
|:-:|------------------------------------------|------------------------------------------------------------------------
| 1 |If the device type of the specified device is not supported by the plugin |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 2 |If the device is not found                |[`DeviceNotFoundHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 3 |If the device is not power capable        |[`RequestNotSupportedHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 4 |If the OS shutdown fails                  |[`PowerOffFailureHwControlError`](07_Handling_Exceptions.md#72-predefined-exceptions)
| 5 |If OOB authentication fails               |[`AuthenticationHwControlError`](07_Handling_Exceptions.md#base-exception-classes)
| 6 |If the manager responds with an error     |[`ControlObjectHwControlError`](07_Handling_Exceptions.md#base-exception-classes)

### 5.8.3. How to Test

Run the [REST API of HW Control Function](02_HWControlFunction.md#21-rest-api-of-hw-control-function) as follows.

1. Specify `CPU` as the device type and run `Get device ID list information` to get a list of device IDs.
2. Specify the acquired device ID and run `Power control` with the request body `{"action": "off"}`.

`Power control` will request the agent to shut down the OS if it is accessible, otherwise the plugin will be shut down.  
If you map a device to an agent (edit `os_ipaddress.yaml`) in [How to Test `get_power_state`](#543-how-to-test),  
remove that setting to allow the plugin to make an OS shutdown request.
